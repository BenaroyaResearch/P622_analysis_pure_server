---
title: "P622-3 10X fixed data on CR called cells: QC and analysis"
output: html_document
author: Naresh Doni Jayavelu
---

&nbsp;

&nbsp;

&nbsp;


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

&nbsp;

&nbsp;

&nbsp;

## Load all necessary libraries, although I do not like to.

```{r loadLibraries, message=FALSE, warning=FALSE, echo=FALSE}
library(Seurat)
library(stringr)
library(ggpubr)
library(gridExtra)
library(car)
library(lme4)
# library(garnett)
library(ggrepel)
library(ggrastr)
library(dplyr)
library(tidyverse)
library(presto)
library(kableExtra)
library(patchwork)
library(ggbeeswarm)
# library(rlang)
library(ggrastr)
# library(BPCells)
library(igraph)
library(ggraph)
library(RColorBrewer)
library(scales)
library(ComplexUpset)

options(stringsAsFactors = FALSE)
set.seed(100)

Csparse_validate = "CsparseMatrix_validate"

```

&nbsp;

&nbsp;

&nbsp;

### Set up the directories
```{r set_up_directories, cache = TRUE}
# baseDir <- "/mnt/bioinformatics/workspace/ndonijayavelu/P608_5_analysis_server"
# baseDir_isilon <- "/nfs/bioinformatics/workspace/ndonijayavelu/P608_5_analysis_server"
baseDir <- "/nfs/pure_bioinformatics/workspace/ndonijayavelu/P622_analysis_pure_server"
# annoExtDir <- "/mnt/bioinformatics/workspace/ndonijayavelu/Annotation_files"
outDir <- file.path(baseDir, "output")
dataDir <- file.path(baseDir, "data")
processedDataDir <- file.path(baseDir, "processed_data")
# tabDir <- file.path(outDir, "scanpy_related", "Tables")
# scanpyDir <- file.path(outDir, "scanpy_related", "without_T176")
# scanpyDir_isilon <- file.path(baseDir_isilon, "output", "scanpy_related", "without_T176")
# degDir <- file.path(outDir, "scanpy_related", "without_T176", "DEGs_list")
# figDir <- file.path(outDir, "scanpy_related", "without_T176", "DEGs_list", "Figures")
# degDir <- file.path(baseDir, "code/without_T176/PseudoBulk_analysis/4_conditions")
# enrichRDir <- file.path(baseDir, "enrichR_database")
# enrichDir <- file.path(baseDir, "code/without_T176/PseudoBulk_DEGs_enrichments")
# figDir <- file.path(baseDir, "code/without_T176/Figs_AAAAI_Feb2026/T2_signature_vs_cellComp")

```


### Define color codes
```{r set_up_directories, cache = TRUE}

col_sel_cell <- c("Basal" = "#DDCBA4FF", "MitoticBasal" = "#D99E4CFF", 
             "SupraBasal" = "#BE3428FF", "Secretory" = "#95C65CFF", 
             "Club" = "#088BBEFF", "Goblet" = "#F28A8AFF", 
             "MucousSecretory" = "#0E7175FF","MucousCiliated" = "#94D0FFFF", 
             "Deuterosomal" = "#FFB900FF", "Ciliated" = "#8795E8FF", 
             "RareCells" = "#C774E8FF")


col_sel_donor <- c(Healthy = "darkgrey", "Non-T2" = "#5773CCFF", "T2" = "#FFB900FF")

col_sel_condition <- c("Uninfected" = "#66C2A5", "RV16" = "#FC8D62", "IL-13" = "#8DA0CB", "IL-13_RV16" = "#E78AC3")

cell_type_levels = c("Basal", "MitoticBasal", "SupraBasal", "Secretory", 
                       "Club", "Goblet", "MucousSecretory", "MucousCiliated", 
                       "Deuterosomal", "Ciliated", "RareCells")
condition_levels <- c("Uninfected", "RV16", "IL-13", "IL-13_RV16")

```


### Analysis on Cell Rangers filtered matrix data 

```{r Read the marker genes list}

# dataDirs
rawdataDirs <- c(
  "/nfs/pure_bioinformatics/pipeline/Illumina/260218_VH00126_450_222HCHWNX/Project_P622-3Processed_bri_260220/pool622-3_1/outs/per_sample_outs")

# Read in samples individually and combine file names
file_names_h5_filtered <- unlist(lapply(rawdataDirs, function(dir) {
  list.files(
    dir,
    full.names = TRUE,
    recursive = TRUE,
    pattern = "sample_filtered_feature_bc_matrix.h5"
  )
}))

# extract sample names from file paths
sampleList <- str_extract(file_names_h5_filtered, "(?<=per_sample_outs/[/]?)[^/]+")

# read expression data
gexObjectsList <- lapply(file_names_h5_filtered, Read10X_h5)
names(gexObjectsList) <- sampleList

lapply(gexObjectsList, dim)

seuratObjectsList <- vector("list", length = length(sampleList))
for (k in 1:length(sampleList)){
  seuratObjectsList[[k]] <- CreateSeuratObject(counts = gexObjectsList[[k]], 
                                               min.features = 0, 
                                               min.cells = 0,
                                               project = sampleList[k])
}

# add QC metrics
for(k in 1:length(seuratObjectsList)){
  seurat_obj <- seuratObjectsList[[k]]
  seurat_obj[["Percent_MT"]] <- PercentageFeatureSet(seurat_obj, pattern = "^MT-")
  seurat_obj[["Percent_RIBO"]] <- PercentageFeatureSet(seurat_obj, pattern = "^RP[SL]")
  seurat_obj[["Percent_HB"]] <- PercentageFeatureSet(seurat_obj, pattern = "^HB[^P]")
  seuratObjectsList[[k]] <- seurat_obj
}

# merge samples
merged_seurat_obj_CR_cells <- merge(x = seuratObjectsList[[1]], 
                      y = seuratObjectsList[2:length(seuratObjectsList)], 
                      add.cell.ids = sampleList)

# make sure merged seurat object is same as individual objects
all(sum(sapply(seuratObjectsList, function(x) dim(x)[2])) == dim(merged_seurat_obj_CR_cells)[2])


# save as an .rds object
# saveRDS(merged_seurat_obj_CR_cells, file = file.path(processedDataDir, "merged_seurat_obj_CR_cells.rds"))
# merged_seurat_obj_CR_cells <- readRDS(file = file.path(processedDataDir, "merged_seurat_obj_CR_cells.rds"))


```


&nbsp;

### QC stats and plots before filtering

```{r QC stats and plots before filtering}

# Extract metadata
metadata_beforeQC <- merged_seurat_obj_CR_cells@meta.data

# Calculate QC metrics
beforeQC_metrics <- metadata_beforeQC %>%
  dplyr::group_by(orig.ident) %>% # Group by sample identifier
  dplyr::summarise(
    num_cells = n(),                          # Number of cells
    # median_RVA_counts = median(RVA_counts),
    # min_RVA_counts = min(RVA_counts),
    # max_RVA_counts = max(RVA_counts),
    median_UMIs = median(nCount_RNA), # Median UMIs per cell
    median_genes = median(nFeature_RNA), # Median genes per cell
    median_MT = median(Percent_MT)
    # min_genes = min(nFeature_RNA), # Min genes per cell
    # max_genes = max(nFeature_RNA) # Min genes per cell
  )


beforeQC_metrics %>% mutate_if(is.numeric, round, 1) %>%
  kbl() %>% kable_paper("hover", full_width = F, bootstrap_options = "condensed", font_size = 12)


# QC plots

generate_histogram_plot <- function(metadata, feature, bins = 50) {
  # Validate input
  if (!feature %in% colnames(metadata)) {
    stop(sprintf("The feature '%s' is not a column in the provided metadata.", feature))
  }
  
  # Calculate median values for the feature by group
  temp_data <- metadata %>%
    group_by(orig.ident) %>%
    summarise(median_number = median(.data[[feature]], na.rm = TRUE))
  
  # Generate plot
  temp_plot <- metadata %>%
    ggplot(aes(x = .data[[feature]])) +
    geom_histogram(bins = bins, color = "black", alpha = 0.7) + # Add histogram
    facet_wrap(~orig.ident, nrow = 4, scales = "free") + # Facet by sample
    geom_vline(data = temp_data, aes(xintercept = median_number), linetype = "dashed", color = "red") + # Median line
    theme_bw() +
    theme(
      axis.text.x = element_text(angle = 90, size = 12),
      axis.text.y = element_text(size = 12),
      axis.title.x = element_text(size = 14),
      axis.title.y = element_text(size = 14),
      legend.text = element_text(size = 14),
      legend.title = element_blank(),
      legend.position = "none"
    ) +
    labs(
      x = feature,
      y = "Cell Count",
      title = sprintf("%s Distribution Across Samples", feature)
    )
  
  # Return the plot
  return(temp_plot)
}

umi_plot <- generate_histogram_plot(
  metadata = metadata_beforeQC, 
  feature = "nCount_RNA", 
  bins = 50
)

gene_plot <- generate_histogram_plot(
  metadata = metadata_beforeQC, 
  feature = "nFeature_RNA", 
  bins = 50
)

mt_plot <- generate_histogram_plot(
  metadata = metadata_beforeQC, 
  feature = "Percent_MT", 
  bins = 50
)

ribo_plot <- generate_histogram_plot(
  metadata = metadata_beforeQC, 
  feature = "Percent_RIBO", 
  bins = 50
)

hb_plot <- generate_histogram_plot(
  metadata = metadata_beforeQC, 
  feature = "Percent_HB", 
  bins = 50
)


```

&nbsp;

### QC stats and plots after filtering

```{r QC stats and plots after filtering}


### Remove bad QC cells
# remove bad QC cells

quantile(metadata_beforeQC$nCount_RNA, probs = seq(0, 1, 0.01))
quantile(metadata_beforeQC$nFeature_RNA, probs = seq(0, 1, 0.01))
quantile(metadata_beforeQC$Percent_MT, probs = seq(0, 1, 0.01))

qcMetricsThresholds <-
  c(
    "min_nFeature_RNA" = 100,
    "max_nFeature_RNA" = 4000,
    "max_nCount_RNA" = 20000,
    "percent_mito" = 10
  )


seurat_obj <- merged_seurat_obj_CR_cells

cellsAfterQCFilter <-
  WhichCells(
    seurat_obj,
    expression = nFeature_RNA >= qcMetricsThresholds["min_nFeature_RNA"]) %>% 
  # keeps 281 of 500
  intersect(
    WhichCells(
      seurat_obj,
      expression = nFeature_RNA <= qcMetricsThresholds["max_nFeature_RNA"])) %>% 
  # keeps 279 of 281
  intersect(
    WhichCells(
      seurat_obj, 
      expression = Percent_MT <= qcMetricsThresholds["percent_mito"])) %>%
  # keeps 255 of 281
  intersect(
    WhichCells(
      seurat_obj,
      expression = nCount_RNA <= qcMetricsThresholds["max_nCount_RNA"]))


# Filter bad/low quality cells
seurat_obj_filtered <- subset(seurat_obj, cells = cellsAfterQCFilter)
seurat_obj_filtered


# QC metrics

# Extract metadata
metadata_afterQC <- seurat_obj_filtered@meta.data


# Calculate QC metrics
afterQC_metrics <- metadata_afterQC %>%
  dplyr::group_by(orig.ident) %>% # Group by sample identifier
  dplyr::summarise(
    num_cells = n(),                          # Number of cells
    median_UMIs = median(nCount_RNA), # Median UMIs per cell
    median_genes = median(nFeature_RNA), # Median genes per cell
    median_MT = median(Percent_MT), # Median genes per cell
    
  )


afterQC_metrics %>% mutate_if(is.numeric, round, 1) %>%
  kbl() %>% kable_paper("hover", full_width = F, bootstrap_options = "condensed", font_size = 12)

# QC plots
umi_plot <- generate_histogram_plot(
  metadata = metadata_afterQC, 
  feature = "nCount_RNA", 
  bins = 50
)

gene_plot <- generate_histogram_plot(
  metadata = metadata_afterQC, 
  feature = "nFeature_RNA", 
  bins = 50
)

mt_plot <- generate_histogram_plot(
  metadata = metadata_afterQC, 
  feature = "Percent_MT", 
  bins = 50
)

ribo_plot <- generate_histogram_plot(
  metadata = metadata_afterQC, 
  feature = "Percent_RIBO", 
  bins = 50
)

hb_plot <- generate_histogram_plot(
  metadata = metadata_afterQC, 
  feature = "Percent_HB", 
  bins = 50
)


```


&nbsp;

### Normalization, Integration and Clustering 

```{r Normalization Integration and Clustering }



### Normalization and clustering 
get_umap_metadata <- function(seurat_obj){
  umap_df <- seurat_obj[["umap"]]@cell.embeddings %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "cell_id")
  meta_df <- seurat_obj@meta.data %>% 
  as.data.frame() %>% 
  tibble::rownames_to_column(var = "cell_id")
  df <- umap_df %>% 
    inner_join(meta_df)
  return(df)
}


# normalization and clustering
seurat_obj_filtered_unintegrated <- NormalizeData(seurat_obj_filtered)
seurat_obj_filtered_unintegrated <- FindVariableFeatures(seurat_obj_filtered_unintegrated)
seurat_obj_filtered_unintegrated <- ScaleData(seurat_obj_filtered_unintegrated)
seurat_obj_filtered_unintegrated <- RunPCA(seurat_obj_filtered_unintegrated)

seurat_obj_filtered_unintegrated <- FindNeighbors(seurat_obj_filtered_unintegrated, dims = 1:50)
# seurat_obj_filtered_unintegrated <- FindClusters(seurat_obj_filtered_unintegrated, resolution = 0.6, cluster.name = "unintegrated_clusters")
# seurat_obj_filtered_unintegrated <- FindClusters(seurat_obj_filtered_unintegrated, resolution = 0.5, cluster.name = "unintegrated_clusters_res0.5")
# seurat_obj_filtered_unintegrated <- FindClusters(seurat_obj_filtered_unintegrated, resolution = 0.4, cluster.name = "unintegrated_clusters_res0.4")
seurat_obj_filtered_unintegrated <- FindClusters(seurat_obj_filtered_unintegrated, resolution = 0.3, cluster.name = "unintegrated_clusters_res0.3")
seurat_obj_filtered_unintegrated <- seurat_obj_filtered_unintegrated %>% RunUMAP(dims = 1:50)

# Visualize umap
DimPlot(seurat_obj_filtered_unintegrated, reduction = "umap", label = TRUE)
DimPlot(seurat_obj_filtered_unintegrated, reduction = "umap", group.by = "orig.ident")
pp <- DimPlot(seurat_obj_filtered_unintegrated, reduction = "umap", group.by = "orig.ident", split.by = "orig.ident", ncol = 8)


# Custom function for DimPlot with user-defined rows and columns
custom_UMAP_Plot <- function(seurat_obj, reduction = "umap", group_by = "orig.ident", split_by = "orig.ident", nrow = NULL, ncol = NULL) {
  # Fetch UMAP embeddings and metadata
  umap_df <- FetchData(seurat_obj, vars = c(paste0(reduction, "_1"), paste0(reduction, "_2"), group_by, split_by))
  
  # Rename columns for ggplot
  colnames(umap_df)[1:2] <- c("UMAP_1", "UMAP_2")
  
  # Base ggplot
  p <- ggplot(umap_df, aes(x = UMAP_1, y = UMAP_2, color = !!sym(group_by))) +
    geom_point(size = 0.5, alpha = 0.8) +
    theme_bw() +
    labs(title = paste("UMAP colored by", group_by)) +
    theme(legend.position = "none")
  
  # Facet wrap if split_by is provided
  if (!is.null(split_by)) {
    p <- p + facet_wrap(as.formula(paste("~", split_by)), nrow = nrow, ncol = ncol)
  }

  return(p)
}

custom_UMAP_Plot(seurat_obj_filtered_unintegrated, nrow = 2, ncol = 14)

# saveRDS(seurat_obj_filtered_unintegrated, file = file.path(processedDataDir, "seurat_obj_filtered_unintegrated_CR.rds"))

seurat_obj_filtered_unintegrated <- readRDS(file = file.path(processedDataDir, "seurat_obj_filtered_unintegrated_CR.rds"))

seurat_obj_filtered_CCA <- seurat_obj_filtered_unintegrated



# marker genes
# re-join layers after integration
seurat_obj_filtered_unintegrated[["RNA"]] <- JoinLayers(seurat_obj_filtered_unintegrated[["RNA"]])

cluster_markers_unintegrated <- FindAllMarkers(seurat_obj_filtered_unintegrated)

# save(cluster_markers_unintegrated, file = file.path(processedDataDir, "cluster_markers_unintegrated_v1_temp_250130.rda"))

# load(file = file.path(outDir, "cluster_markers_unintegrated_v1_temp_250130.rda"))







```


&nbsp;

### Harmony integration 

```{r Harmony integration}

seurat_obj_filtered_unintegrated <- readRDS(file = file.path(processedDataDir, "seurat_obj_filtered_unintegrated_CR.rds"))

options(future.globals.maxSize = 100 * 1024^3) 

seurat_obj_harmony_integrated_CR <- IntegrateLayers(
  object = seurat_obj_filtered_unintegrated, method = HarmonyIntegration,
  orig.reduction = "pca", new.reduction = "harmony",
  verbose = TRUE
) # Harmony converged after 5 iterations

# saveRDS(seurat_obj_harmony_integrated_CR, file = file.path(processedDataDir, "seurat_obj_harmony_integrated_CR.rds"))

# re-join layers after integration
seurat_obj_harmony_integrated_CR[["RNA"]] <- JoinLayers(seurat_obj_harmony_integrated_CR[["RNA"]])

seurat_obj_harmony_integrated_CR <- FindNeighbors(seurat_obj_harmony_integrated_CR, reduction = "harmony", dims = 1:50)
seurat_obj_harmony_integrated_CR <- FindClusters(seurat_obj_harmony_integrated_CR, resolution = 0.3, cluster.name = "harmony_clusters")
seurat_obj_harmony_integrated_CR <- RunUMAP(seurat_obj_harmony_integrated_CR, reduction = "harmony", dims = 1:50, reduction.name = "umap.harmony")

# quick visualization
DimPlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", label = TRUE)
DimPlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", group.by = "orig.ident")
pp <- DimPlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", group.by = "orig.ident", split.by = "orig.ident", ncol = 8)
pp <- DimPlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", group.by = "harmony_clusters", label = TRUE, split.by = "orig.ident", ncol = 8)

# saveRDS(seurat_obj_harmony_integrated_CR, file = file.path(processedDataDir, "seurat_obj_harmony_integrated_CR_with_UMAP.rds"))

# marker genes
cluster_markers_harmony_CR <- FindAllMarkers(seurat_obj_harmony_integrated_CR)
# save(cluster_markers_harmony_CR, file = file.path(processedDataDir, "cluster_markers_harmony_integrated_CR_temp_260226.rda"))

table(seurat_obj_harmony_integrated_ED@meta.data$harmony_clusters)

library(gt)
table(seurat_obj_harmony_integrated_CR@meta.data$harmony_clusters) %>%
  as.data.frame() %>%
  rename(Cluster = Var1, Cell_Count = Freq) %>%
  mutate(Percent = round(Cell_Count / sum(Cell_Count) * 100, 2)) %>%
  gt() %>%
  tab_header(
    title    = md("**Cell Counts per Harmony Cluster**"),
    subtitle = md(paste0("Total cells: **", sum(table(seurat_obj_harmony_integrated_CR@meta.data$harmony_clusters)), "**"))
  ) %>%
  cols_label(
    Cluster    = md("**Cluster**"),
    Cell_Count = md("**Cell Count**"),
    Percent    = md("**% of Total**")
  ) %>%
  fmt_number(columns = Cell_Count, decimals = 0, use_seps = TRUE) %>%
  fmt_number(columns = Percent, decimals = 2) %>%
  data_color(
    columns = Cell_Count,
    palette = "Blues"
  ) %>%
  grand_summary_rows(
    columns  = Cell_Count,
    fns      = list(Total ~ sum(.)),
    fmt      = ~ fmt_number(., decimals = 0, use_seps = TRUE)
  ) %>%
  tab_options(
    table.font.size         = 14,
    heading.title.font.size = 16,
    column_labels.font.weight = "bold",
    table.border.top.color  = "black",
    table.border.bottom.color = "black"
  )



# neutrophils
neut_markers <- c("CSF3R", "G0S2", "CXCL8", "NAMPT", "PPIF", "ITGAX", "IL1B", "RNF149", "SOD2", "AQP9", "TREM1", "FCGR3A")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = neut_markers)
FeaturePlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", features = neut_markers)

# IFN markers
IFN_markers <- c("MX1", "MX2", "IFIT1", "IFIT2", "IFIT3", "ISG15", "IFI44", "OAS1", "OAS3", "OASL")
#IFN_markers2 <- c("OAS1", "OAS3")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = neut_markers)
FeaturePlot(seurat_obj_filtered_ED_query, reduction = "umap.cca", features = neut_markers)

# eosinophils
eos_markers <- c("IL3RA", "FHL3", "CD69", "CKLF", "CD300LF", "PRR5L", "PNPLA6", "SYNE1", "RAB44")
eos_markers <- c("IL3RA", "CD69")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = eos_markers)
FeaturePlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", features = eos_markers)

# basophils
baso_markers <- c("CPA3", "HDC", "GATA2", "SOCS2", "IL4", "IL13", "IL1RL1")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = baso_markers)
FeaturePlot(seurat_obj_filtered_ED_query_CCA, reduction = "umap.cca", features = baso_markers)

# mast cells
mast_markers <- c("CPA3", "HDC", "GATA2", "KIT", "MS4A2")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = mast_markers)
FeaturePlot(seurat_obj_harmony_integrated_CR, reduction = "umap.harmony", features = mast_markers)

# B cells
# bcells_markers <- c("MS4A1", "CD79A", "IGHM", "IRF8", "TNFRSF13C", "TNFRSF13B")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = bcells_markers)

# B cells
bcells_markers <- c("MS4A1", "CD74", "CD79A", "IGHM", "TNFRSF13B", "TNFRSF13C")

# NK & T cells
nk_tcells_markers <- c("IL2RB", "IL2RG", "IL32", "TRAC", "TRBC2", "TRC1D10C", "CD3E", "CD3D", "CCL5", "CXCR4")
FeaturePlot(seurat_obj_filtered_ED_query_CCA, reduction = "umap.cca", features = nk_tcells_markers)

# Monocytes
mono_markers <- c("C1QA", "C1QB", "C1QC", "CD300E", "VCAN", "LYZ", "TIMP1", "CSF1R", "STAB1", "TGFBI")

# Plasmacytoid dendritic cells
pdc_markers <- c("GZMB", "LILRA4", "JCHAIN", "MAP1A", "PTPRS")
FeaturePlot(seurat_obj_filtered_ED_query_CCA, reduction = "umap.cca", features = pdc_markers)

# Squamous and Basal cells
sqm_basal_markers <- c("SPRR3", "SCEL", "MAL", "SPRR1B", "KRT4", "KRT13", "KRT5", "KRT15", "KRT80", "KRT6A", "KRT78")

# Goblet cells
gob_markers <- c("MUC5AC", "WFDC2", "BPIFA1", "BPIFB1", "SLPI", "SCGB1A1")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = gob_markers)
FeaturePlot(seurat_obj_filtered_ED_query, reduction = "umap.cca", features = gob_markers)

# Mucus secreting cells
muc_sec_cells_markers <- c("ELF3", "CLDN7", "CLDN4", "MUC1", "MUC4", "MUC20")


# Ciliated cells
cil_markers <- c("FOXJ1", "CAPS", "PIFO", "C20orf85", "SNTN", "TUBB4B")
# FeaturePlot(seurat_obj_filtered_CR_ref, reduction = "umap.cca", features = cil_markers)
FeaturePlot(seurat_obj_filtered_ED_query, reduction = "umap.cca", features = cil_markers)




```


&nbsp;

### QC metrics by cluster

```{r QC metrics by cluster}

metadata_afterQC <- seurat_obj_harmony_integrated_CR@meta.data
# Calculate QC metrics
QC_metrics_by_cluster <- metadata_afterQC %>%
  dplyr::group_by(harmony_clusters) %>% # Group by sample identifier
  dplyr::summarise(
    num_cells = n(),                          # Number of cells
    median_UMIs = median(nCount_RNA), # Median UMIs per cell
    median_genes = median(nFeature_RNA), # Median genes per cell
    median_MT = median(Percent_MT), # Median genes per cell
    
  )


library(gt)
library(dplyr)

# Cluster annotations
cluster_annotations <- c(
  "0"  = "Monocytes/Macrophages",
  "1"  = "B cells",
  "2"  = "Neutrophils",
  "3"  = "Epithelial cells",
  "4"  = "Epithelial cells (Ciliated)",
  "5"  = "Epithelial cells",
  "6"  = "Monocytes/Macrophages",
  "7"  = "T & NK cells",
  "8"  = "Neutrophils",
  "9"  = "Epithelial cells",
  "10" = "pDC",
  "11" = "Proliferating cells (B cells)?",
  "12" = "Monocytes/Macrophages",
  "13" = "B cells"
)

# Cell type colors
celltype_colors <- c(
  "Monocytes/Macrophages"          = "#E69F00",
  "B cells"                        = "#56B4E9",
  "Neutrophils"                    = "#009E73",
  "Epithelial cells"               = "#CC79A7",
  "Epithelial cells (Ciliated)"    = "#D55E00",
  "T & NK cells"                   = "#0072B2",
  "pDC"                            = "#F0E442",
  "Proliferating cells (B cells)?" = "#999999"
)

QC_metrics_by_cluster <- metadata_afterQC %>%
  dplyr::group_by(harmony_clusters) %>%
  dplyr::summarise(
    num_cells    = n(),
    median_UMIs  = median(nCount_RNA),
    median_genes = median(nFeature_RNA),
    median_MT    = median(Percent_MT)
  ) %>%
  mutate(
    harmony_clusters = as.character(harmony_clusters),
    Cell_Type        = cluster_annotations[harmony_clusters],
    Cluster          = paste0("C", harmony_clusters),
    Percent_of_Total = round(num_cells / sum(num_cells) * 100, 2)
  ) %>%
  select(Cluster, Cell_Type, num_cells, Percent_of_Total, median_UMIs, median_genes, median_MT)

QC_metrics_by_cluster %>%
  gt() %>%
  tab_header(
    title    = md("**QC Metrics by Harmony Cluster**"),
    subtitle = md(paste0("Total cells: **", sum(QC_metrics_by_cluster$num_cells), "**"))
  ) %>%
  cols_label(
    Cluster          = md("**Cluster**"),
    Cell_Type        = md("**Cell Type**"),
    num_cells        = md("**Cells**"),
    Percent_of_Total = md("**% Total**"),
    median_UMIs      = md("**Median UMIs**"),
    median_genes     = md("**Median Genes**"),
    median_MT        = md("**Median MT%**")
  ) %>%
  # Color the Cell Type column by cell type
  tab_style(
    style = cell_fill(color = "#E69F0033"),
    locations = cells_body(rows = Cell_Type == "Monocytes/Macrophages")
  ) %>%
  tab_style(
    style = cell_fill(color = "#56B4E933"),
    locations = cells_body(rows = Cell_Type %in% c("B cells", "Proliferating cells (B cells)?"))
  ) %>%
  tab_style(
    style = cell_fill(color = "#009E7333"),
    locations = cells_body(rows = Cell_Type == "Neutrophils")
  ) %>%
  tab_style(
    style = cell_fill(color = "#CC79A733"),
    locations = cells_body(rows = grepl("Epithelial", Cell_Type))
  ) %>%
  tab_style(
    style = cell_fill(color = "#0072B233"),
    locations = cells_body(rows = Cell_Type == "T & NK cells")
  ) %>%
  tab_style(
    style = cell_fill(color = "#F0E44233"),
    locations = cells_body(rows = Cell_Type == "pDC")
  ) %>%
  # Bold cluster column
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_body(columns = Cluster)
  ) %>%
  # Color scale for median MT%
  data_color(
    columns = median_MT,
    palette = c("white", "red"),
    domain  = c(0, max(QC_metrics_by_cluster$median_MT))
  ) %>%
  # Color scale for cell counts
  data_color(
    columns = num_cells,
    palette = "Blues"
  ) %>%
  fmt_number(columns = c(median_UMIs, median_genes), decimals = 0, use_seps = TRUE) %>%
  fmt_number(columns = c(median_MT, Percent_of_Total), decimals = 2) %>%
  grand_summary_rows(
    columns = num_cells,
    fns     = list(Total ~ sum(.)),
    fmt     = ~ fmt_number(., decimals = 0, use_seps = TRUE)
  ) %>%
  tab_spanner(
    label   = md("**Cell Counts**"),
    columns = c(num_cells, Percent_of_Total)
  ) %>%
  tab_spanner(
    label   = md("**QC Metrics**"),
    columns = c(median_UMIs, median_genes, median_MT)
  ) %>%
  # tab_footnote(
  #   footnote  = "MT% threshold used for QC filtering: 10%",
  #   locations = cells_column_labels(columns = median_MT)
  # ) %>%
  tab_options(
    table.font.size              = 13,
    heading.title.font.size      = 16,
    heading.subtitle.font.size   = 13,
    column_labels.font.weight    = "bold",
    table.border.top.color       = "black",
    table.border.bottom.color    = "black",
    row.striping.include_table_body = FALSE
  )


cluster_annotations_df <- data.frame(
  harmony_clusters = names(cluster_annotations),
  cell_type       = unname(cluster_annotations)
)


cell_metadata_CR <- seurat_obj_harmony_integrated_CR@meta.data %>%
  tibble::rownames_to_column(var = "cell_id") %>%
  inner_join(cluster_annotations_df) 

# save(cell_metadata_CR, file = file.path(processedDataDir, "cell_metadata_CR_temp_260226.rda"))

```





